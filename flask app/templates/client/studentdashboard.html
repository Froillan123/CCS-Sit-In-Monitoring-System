{% extends 'client/clientbase.html' %}

{% block content %}
<style>
  :root
  {
    --text-color: #333;
  }
</style>
<!-- Dashboard Container -->
<div class="dashboard-wrapper">
  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Profile Section -->
    <div class="profile-section">
      <div class="profile-image">
        <!-- Display the profile picture -->
        <img src="{{ url_for('static', filename='images/' + student.profile_picture if student.profile_picture else 'default.png') }}" alt="Profile Picture" />
      </div>
      <div class="profile-info">
        <h3>{{ student.firstname }} {{ student.lastname }}</h3>
      </div>
    </div>

    <!-- Sidebar Links -->
    <div class="sidebar-links">
      <a href="#" data-section="dashboard">Dashboard</a>
      <a href="#" data-section="profile">Profile</a>
      <a href="#" data-section="announcements">Announcements</a>
      <a href="#" data-section="lab-rules">Lab Rules</a>
      <a href="#" data-section="history">History</a>
      <a href="#" data-section="reservations">Reservations</a>
      <a href="#" data-section="laboratories">Laboratories</a>
      <a href="" data-section="sessions">View Session</a>
    </div>
    <div class="button-container" style="margin-top: 4rem;">
      <a href="{{ url_for('logout') }}" id="logout-link">
        <button type="button" class="btn btn-danger">Log Out</button>
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="dashboard-container">
    <!-- Dashboard Section -->
    <div id="dashboard" class="dashboard-section">
      <div class="dashboard-header">
        <div class="welcome-message">
          <h1>Welcome, {{ student.firstname }}!</h1>
          <p>We're glad to have you back on your student dashboard.</p>
      
          <div class="sit-in-rules-section">
            <h3>Sit-In Laboratory Rules</h3>
            <ul>
                <li>No playing games (including computer-related and card games) inside the lab.</li>
                <li>Mobile phones, walkmans, and other personal equipment must be switched off.</li>
                <li>Internet surfing is allowed only with instructor permission. No downloading or installing software.</li>
                <li>Accessing unrelated websites (especially inappropriate content) is strictly prohibited.</li>
                <li>Do not delete files or alter computer settings.</li>
                <li>Each use is limited to 15 minutes. After that, the unit is available for those waiting.</li>
                <li>Observe proper decorum: only enter the lab when the instructor is present.</li>
                <li>All bags must be deposited at the counter. Follow the instructor's seating arrangement.</li>
                <li>Chewing gum, eating, drinking, and smoking are prohibited inside the lab.</li>
                <li>Continual disturbances may lead to removal from the lab.</li>
                <li>Serious offenses may involve intervention from campus security.</li>
            </ul>
        </div>
        
      </div>
    </div>

      <!-- Laboratories Section -->
      <div class="laboratories-section">
        <h2>Laboratories</h2>
        <div class="laboratory-grid">
          <a href="#" class="laboratory-card">
            <h3>Lab 1</h3>
            <p>Chemistry Lab</p>
          </a>
          <a href="#" class="laboratory-card">
            <h3>Lab 2</h3>
            <p>Physics Lab</p>
          </a>
          <a href="#" class="laboratory-card">
            <h3>Lab 3</h3>
            <p>Biology Lab</p>
          </a>
          <a href="#" class="laboratory-card">
            <h3>Lab 4</h3>
            <p>Computer Lab</p>
          </a>
          <a href="#" class="laboratory-card">
            <h3>Lab 5</h3>
            <p>Engineering Lab</p>
          </a>
          <a href="#" class="laboratory-card">
            <h3>Lab 6</h3>
            <p>Research Lab</p>
          </a>
        </div>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profile" class="dashboard-section" style="display: none;">
      <h1>Profile</h1>
      <div class="profile-container">
        <div class="profile-card">
          <!-- Profile Picture -->
          <div class="profile-header">
            <div class="profile-picture" onclick="document.getElementById('profile-picture-upload').click()">
              <img id="profile-picture" src="{{ url_for('static', filename='images/' + student.profile_picture if student.profile_picture else 'default.png') }}" alt="Profile Picture" />
              <input type="file" id="profile-picture-upload" style="display: none;" />
            </div>
          </div>
          <!-- Student Details -->
          <div class="profile-details">
            <div class="detail-item">
              <label for="editable-firstname">Idno:</label>
              <input type="text" id="editable-firstname" value="{{ student.idno }}" readonly />
            </div>            
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-firstname">First Name:</label>
                <input type="text" id="editable-firstname" value="{{ student.firstname }}" />
              </div>
              <div class="detail-item">
                <label for="editable-lastname">Last Name:</label>
                <input type="text" id="editable-lastname" value="{{ student.lastname }}" />
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-midname">Middle Name:</label>
                <input type="text" id="editable-midname" value="{{ student.midname }}" />
              </div>
              <div class="detail-item">
                <label for="editable-course">Course:</label>
                <input type="text" id="editable-course" value="{{ student.course }}" />
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-year-level">Year Level:</label>
                <input type="text" id="editable-year-level" value="{{ student.year_level }}" />
              </div>
              <div class="detail-item">
                <label for="editable-email">Email:</label>
                <input type="email" id="editable-email" value="{{ student.email }}" />
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-username">Username:</label>
                <input type="text" id="editable-username" value="{{ student.username }}" />
              </div>
            </div>
          </div>
          <!-- Save Button -->
          <button onclick="saveProfileChanges()">Save Changes</button>
        </div>
      </div>
    </div>

      <!-- Announcements Section -->
      <div id="announcements" class="dashboard-section" style="display: block;">
        <h1>Announcements</h1>
        <div id="announcements-list" class="announcements-container">
          <!-- Announcements will be dynamically inserted here -->
        </div>
      </div>
    

   <!-- Lab Rules Section -->
<div id="lab-rules" class="dashboard-section" style="display: none;">
  <h1>Lab Rules and Regulations</h1>
  <div class="rules-container">
    <div class="rules-header">
      <h2>University of Cebu</h2>
      <h3>COLLEGE OF INFORMATION & COMPUTER STUDIES</h3>
    </div>
    <div class="rules-content">
      <p>To avoid embarrassment and maintain camaraderie with your friends and superiors at our laboratories, please observe the following:</p>
      <ol class="rules-list">
        <li>Maintain silence, proper decorum, and discipline inside the laboratory. Mobile phones, walkmans, and other personal pieces of equipment must be switched off.</li>
        <li>Games are not allowed inside the lab. This includes computer-related games, card games, and other games that may disturb the operation of the lab.</li>
        <li>Surfing the Internet is allowed only with the permission of the instructor. Downloading and installing of software are strictly prohibited.</li>
        <li>Getting access to other websites not related to the course (especially pornographic and illicit sites) is strictly prohibited.</li>
        <li>Deleting computer files and changing the set-up of the computer is a major offense.</li>
        <li>Observe computer time usage carefully. A fifteen-minute allowance is given for each use. Otherwise, the unit will be given to those who wish to "sit-in".</li>
        <li>Observe proper decorum while inside the laboratory:
          <ul>
            <li>Do not get inside the lab unless the instructor is present.</li>
            <li>All bags, knapsacks, and the likes must be deposited at the counter.</li>
            <li>Follow the seating arrangement of your instructor.</li>
            <li>At the end of class, all software programs must be closed.</li>
            <li>Return all chairs to their proper places after using.</li>
          </ul>
        </li>
        <li>Chewing gum, eating, drinking, smoking, and other forms of vandalism are prohibited inside the lab.</li>
        <li>Anyone causing a continual disturbance will be asked to leave the lab. Acts or gestures offensive to the members of the community, including public display of physical intimacy, are not tolerated.</li>
        <li>Persons exhibiting hostile or threatening behavior such as yelling, swearing, or disregarding requests made by lab personnel will be asked to leave the lab.</li>
        <li>For serious offenses, the lab personnel may call the Civil Security Office (CSU) for assistance.</li>
        <li>Any technical problem or difficulty must be addressed to the laboratory supervisor, student assistant, or instructor immediately.</li>
      </ol>
      <div class="disciplinary-action">
        <h3>DISCIPLINARY ACTION</h3>
        <p><strong>First Offense:</strong> The Head or the Dean or OIC recommends to the Guidance Center for a suspension from classes for each offender.</p>
        <p><strong>Second and Subsequent Offenses:</strong> A recommendation for a heavier sanction will be endorsed to the Guidance Center.</p>
      </div>
    </div>
  </div>
</div>
    <!-- History Section -->
    <div id="history" class="dashboard-section" style="display: none;">
      <h1>History</h1>
      <p>This is the history section. You can display user history here.</p>
    </div>

<!-- Reservation Section -->
<div id="reservations" class="dashboard-section">
  <h1>Reservation Form</h1>
  <form id="reservationForm">
    <div class="form-group">
      <label for="lab_name">Lab:</label>
      <select id="lab_name" name="lab_name" required>
        <option value="">Select Lab</option>
        {% for lab in labs %}
          <option value="{{ lab.lab_name }}">{{ lab.lab_name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="purpose">Purpose:</label>
      <textarea id="purpose" name="purpose" placeholder="Enter the purpose of the reservation" required></textarea>
    </div>

    <div class="form-group">
      <label for="reservation_date">Reservation Date:</label>
      <input type="date" id="reservation_date" name="reservation_date" required />
    </div>

    <div class="form-group">
      <label for="time_in">Time In:</label>
      <input type="time" id="time_in" name="time_in" required />
    </div>

    <div class="form-group">
      <label for="time_out">Time Out:</label>
      <input type="time" id="time_out" name="time_out" required />
    </div>

    <button type="submit">Submit Reservation</button>
  </form>

  <!-- Message Display -->
  <div id="message"></div>
</div>

    <!-- Laboratories Section -->
    <div id="laboratories" class="dashboard-section" style="display: none;">
      <h1>Laboratories</h1>
      <p>This is the laboratories section. You can display laboratory details here.</p>
    </div>

    <div id="sessions" class="dashboard-section" style="display: none;">
      <h1>Sessions</h1>
      <p id="session-data">Loading sessions...</p>
    </div>
    

  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
  // Section Toggling Logic
  const links = document.querySelectorAll('.sidebar-links a');
  const sections = document.querySelectorAll('.dashboard-section');

  // Function to show the selected section and hide others
  function showSection(sectionId) {
    sections.forEach(section => {
      if (section.id === sectionId) {
        section.style.display = 'block'; // Show the selected section
      } else {
        section.style.display = 'none'; // Hide all other sections
      }
    });

    // Save the active section to localStorage
    localStorage.setItem('activeSection', sectionId);
  }

  // Function to set the active link
  function setActiveLink(sectionId) {
    links.forEach(link => {
      if (link.getAttribute('data-section') === sectionId) {
        link.classList.add('active'); // Add active class to the clicked link
      } else {
        link.classList.remove('active'); // Remove active class from other links
      }
    });
  }

  // Load the active section from localStorage
  const activeSection = localStorage.getItem('activeSection') || 'dashboard';
  showSection(activeSection);
  setActiveLink(activeSection);

  // Add click event listeners to sidebar links
  links.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const sectionId = this.getAttribute('data-section');
      showSection(sectionId); // Show the selected section
      setActiveLink(sectionId); // Set the active link
    });
  });

  // Clear localStorage on logout
  document.getElementById('logout-link').addEventListener('click', function () {
    localStorage.removeItem('activeSection');
  });

  // Profile Picture Upload Handling
  const profilePictureUpload = document.getElementById('profile-picture-upload');
  if (profilePictureUpload) {
    profilePictureUpload.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('profile-picture').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }
});

// Function to save profile changes
function saveProfileChanges() {
  const updatedData = {
    firstname: document.getElementById('editable-firstname').value,
    lastname: document.getElementById('editable-lastname').value,
    midname: document.getElementById('editable-midname').value,
    course: document.getElementById('editable-course').value,
    year_level: document.getElementById('editable-year-level').value,
    email: document.getElementById('editable-email').value,
    username: document.getElementById('editable-username').value
  };

  const formData = new FormData();
  formData.append('data', JSON.stringify(updatedData));
  const profilePictureFile = document.getElementById('profile-picture-upload').files[0];
  if (profilePictureFile) {
    formData.append('profile_picture', profilePictureFile);
  }

  fetch('/update_profile', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      alert('Profile updated successfully!');
      window.location.reload(); // Refresh the page to reflect changes
    } else {
      alert('Failed to update profile: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred while updating the profile.');
  });
}

// Fetch announcements
const announcementsList = document.getElementById('announcements-list');

function fetchAnnouncements() {
    fetch('/get_announcements')
        .then(response => response.json())
        .then(data => {
            announcementsList.innerHTML = ''; // Clear existing announcements

            data.forEach(announcement => {
                const announcementDate = new Date(announcement.announcement_date).toLocaleString();

                const announcementBox = document.createElement('div');
                announcementBox.className = 'announcement-box';

                announcementBox.innerHTML = `
                    <div class="announcement-header">
                        <span class="announcement-date">${announcementDate}</span>
                        <span class="announcement-admin">Posted by: ${announcement.admin_username}</span>
                    </div>
                    <div class="announcement-content">
                        <p>${announcement.announcement_text}</p>
                    </div>
                `;

                announcementsList.appendChild(announcementBox);
            });
        })
        .catch(error => console.error('Error fetching announcements:', error));
}

// Fetch announcements when the page loads
document.addEventListener('DOMContentLoaded', fetchAnnouncements);


// Handle reservation form submission
document.getElementById('reservationForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/reservations', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const messageDiv = document.getElementById('message');
        if (data.status === 'success') {
            messageDiv.textContent = data.message;
            messageDiv.style.color = 'green';
        } else {
            messageDiv.textContent = data.message;
            messageDiv.style.color = 'red';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('message').textContent = 'An error occurred. Please try again.';
    });
});

function fetchLabs() {
    fetch('/get_labs')
        .then(response => response.json())
        .then(data => {
            console.log('Labs data:', data);  // Add this to check the data you're getting
            const labSelect = document.getElementById('lab_name');
            labSelect.innerHTML = '<option value="">Select Lab</option>'; // Reset options

            if (data.success && data.labs.length > 0) {
                data.labs.forEach(lab => {
                    const option = document.createElement('option');
                    option.value = lab.id;
                    option.textContent = lab.lab_name;
                    labSelect.appendChild(option);
                });
            } else {
                console.error('No labs found or error in response');
            }
        })
        .catch(error => {
            console.error('Error fetching labs:', error);
        });
}
 // Embed the idno in a JavaScript variable
 const studentIdno = "{{ idno }}";  // This will be replaced with the actual idno

// Function to fetch session data
function fetchSessionData(idno) {
  fetch(`/get_sessions/${idno}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        document.getElementById('session-data').textContent = data.error;
      } else {
        document.getElementById('session-data').textContent = `Sessions Left: ${data.sessions_left}`;
      }
    })
    .catch(error => {
      console.error('Error fetching session data:', error);
      document.getElementById('session-data').textContent = 'Failed to load session data.';
    });
}

// Fetch session data for the logged-in student
fetchSessionData(studentIdno);
</script>
{% endblock %}