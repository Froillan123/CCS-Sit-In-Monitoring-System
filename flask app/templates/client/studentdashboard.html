{% extends 'client/clientbase.html' %}

{% block content %}
<style>
  :root
  {
    --text-color: #333;
  }

  .sidebar.zoomed {
  max-height: 100vh; /* Applied when zoom level is high */
  min-height: auto; /* Override min-height */
}

</style>
      <!-- Dashboard Container -->
          <div class="dashboard-wrapper">
            <!-- Sidebar -->
            <div class="sidebar">
             

              <!-- Profile Section -->
              <div class="profile-section">
                <div class="profile-image">
                  <img src="{{ url_for('static', filename='images/' + student.profile_picture if student.profile_picture else 'default.png') }}" alt="Profile Picture" />
                </div>
                <div class="profile-info">
                  <h3>{{ student.firstname }} {{ student.lastname }}</h3>
                </div>
              </div>

              <!-- Sidebar Links -->
              <div class="sidebar-links">
                <a href="#" data-section="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="#" data-section="profile"><i class="fas fa-user"></i><span>Profile</span></a>
                <a href="#" data-section="announcements"><i class="fas fa-bullhorn"></i><span>Announcements</span></a>
                <a href="#" data-section="lab-rules"><i class="fas fa-clipboard-list"></i><span>Lab Rules</span></a>
                <a href="#" data-section="history"><i class="fas fa-history"></i><span>History</span></a>
                <a href="#" data-section="reservations"><i class="fas fa-calendar-alt"></i><span>Reservations</span></a>
                <a href="#" data-section="laboratories"><i class="fas fa-desktop"></i><span>Laboratories</span></a>
                <a href="#" data-section="sessions"><i class="fas fa-eye"></i><span>View Session</span></a>
              </div>

              <div class="log-out-small-size">
                <a href="{{ url_for('logout') }}" id="logout-link"><i class="fas fa-sign-out-alt"></i><span></span></a>
              </div>

              <!-- Logout Button -->
              <div class="button-container">
                <a href="{{ url_for('logout') }}" id="logout-link">
                  <button type="button" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> <span class="logout-text">Log Out</span>
                  </button>
                </a>
              </div>              
            </div>

  <!-- Main Content -->
      <div class="dashboard-container">
        
        <div id="dashboard" class="dashboard-section">
          <!-- Top Section: Welcome, Notifications, Calendar -->
          <div class="top-section">
            <!-- Welcome Message on the Left -->
            <div class="welcome-message">
              <h1>Welcome, {{ student.firstname }}!</h1>
              <p>We're glad to have you back on your student dashboard.</p>
            </div>
        
            <!-- Buttons on the Right -->
            <div class="notification-calendar">
              <button class="notification-button">
                <i class="fas fa-bell"></i> Notifications
              </button>
              <button class="calendar-button">
                <i class="fas fa-calendar-alt"></i> Calendar
              </button>
            </div>
          </div>
        
          <!-- Middle Section: Sit-In Rules and Chart -->
          <div class="middle-section">
            <!-- Sit-In Rules Box -->
            <div class="rules-box">
              <h3>Sit-In Laboratory Rules</h3>
              <ul class="rules-list">
                <li>
                  <i class="fas fa-ban"></i> No games, personal devices, or inappropriate content.
                </li>
                <li>
                  <i class="fas fa-cog"></i> Do not alter computer settings or delete files.
                </li>
                <li>
                  <i class="fas fa-chair"></i> Follow seating arrangements and deposit bags at the counter.
                </li>
                <li>
                  <i class="fas fa-utensils"></i> No food, drinks, or smoking in the lab.
                </li>
                <li>
                  <i class="fas fa-exclamation-triangle"></i> Disturbances may lead to removal or security intervention.
                </li>
                <li>
                  <i class="fas fa-tools"></i> Handle equipment with care – Report any damages or issues immediately to the instructor.
                </li>
                <li>
                  <i class="fas fa-headphones"></i> Use headphones for audio – Keep noise levels low to avoid disturbing others.
                </li>
                <li>
                  <i class="fas fa-sign-out-alt"></i> Log out after use – Ensure you log out from all accounts and close applications before leaving.
                </li>
              </ul>
            </div>
        
            <!-- Chart Box -->
            <div class="chart-box">
              <h3>Lab Usage Chart</h3>
              <canvas id="labUsageChart"></canvas> <!-- Chart will be rendered here -->
            </div>
          </div>
          
          <div class="stats-section">
            <!-- Total Sessions Left Box -->
            <div class="stats-box">
                <div class="circular-progress" data-progress="{{ current_session['sessions_left'] if current_session else 0 }}" data-max="30">
                    <svg viewBox="0 0 100 100">
                        <circle class="progress-background" cx="50" cy="50" r="45"></circle>
                        <circle class="progress-bar" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div class="progress-text">
                        <span class="progress-value">{{ current_session['sessions_left'] if current_session else 0 }}</span>
                        <span class="progress-max">/30</span>
                    </div>
                </div>
                <h3>Total Sessions Left</h3>
            </div>
        
            <!-- Available Laboratories Box -->
            <div class="stats-box">
                <div class="circular-progress" data-progress="6" data-max="6">
                    <svg viewBox="0 0 100 100">
                        <circle class="progress-background" cx="50" cy="50" r="45"></circle>
                        <circle class="progress-bar" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div class="progress-text">
                        <span class="progress-value">6</span>
                        <span class="progress-max">/6</span>
                    </div>
                </div>
                <h3>Available Laboratories</h3>
            </div>
        </div>

          <div class="bottom-section">
            
            <div class="chart-container">
              <h3>Activity Breakdown Chart</h3>
              <canvas id="activityBreakdownChart"></canvas>
          </div>
          

            <div class="chart-container">
              <h3>Weekly Usage Chart</h3>
              <canvas id="weeklyUsageChart"></canvas>
            </div>
          </div>
          
        </div>



    <div id="profile" class="dashboard-section" style="display: none;">
      <div class="profile-container">
        <div class="profile-card">
          <!-- Profile Picture -->
          <div class="profile-header">
            <div class="profile-picture" onclick="document.getElementById('profile-picture-upload').click()">
              <img id="profile-picture" src="{{ url_for('static', filename='images/' + student.profile_picture if student.profile_picture else 'default.png') }}" alt="Profile Picture" />
              <input type="file" id="profile-picture-upload" style="display: none;" />
              <div class="edit-overlay"><i class="fas fa-camera"></i></div>
            </div>
          </div>
          <!-- Student Details -->
          <div class="profile-details">
            <div class="detail-item">
              <label for="editable-idno"><i class="fas fa-id-card"></i> ID Number:</label>
              <input type="text" id="editable-idno" value="{{ student.idno }}" readonly />
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-firstname"><i class="fas fa-user"></i> First Name:</label>
                <input type="text" id="editable-firstname" value="{{ student.firstname }}" />
              </div>
              <div class="detail-item">
                <label for="editable-lastname"><i class="fas fa-user"></i> Last Name:</label>
                <input type="text" id="editable-lastname" value="{{ student.lastname }}" />
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-midname"><i class="fas fa-user"></i> Middle Name:</label>
                <input type="text" id="editable-midname" value="{{ student.midname }}" />
              </div>
              <div class="detail-item">
                <label for="editable-course"><i class="fas fa-graduation-cap"></i> Course:</label>
                <input type="text" id="editable-course" value="{{ student.course }}" />
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-year-level"><i class="fas fa-calendar-alt"></i> Year Level:</label>
                <input type="text" id="editable-year-level" value="{{ student.year_level }}" />
              </div>
              <div class="detail-item">
                <label for="editable-email"><i class="fas fa-envelope"></i> Email:</label>
                <input type="email" id="editable-email" value="{{ student.email }}" />
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-item">
                <label for="editable-username"><i class="fas fa-user-circle"></i> Username:</label>
                <input type="text" id="editable-username" value="{{ student.username }}" readonly/>
              </div>
            </div>
          </div>
          <!-- Save Button -->
          <button class="save-button" onclick="saveProfileChanges()"><i class="fas fa-save"></i> Save Changes</button>
        </div>
      </div>
    </div>

      <!-- Announcements Section -->
      <div id="announcements" class="dashboard-section" style="display: block;">
        <h1>Announcements</h1>
        <div id="announcements-list" class="announcements-container">
          <!-- Announcements will be dynamically inserted here -->
        </div>
      </div>
    

        <!-- Lab Rules Section -->
      <div id="lab-rules" class="dashboard-section" style="display: none;">
        <h1>Lab Rules and Regulations</h1>
        <div class="rules-container">
          <div class="rules-header">
            <h2>University of Cebu</h2>
            <h3>COLLEGE OF INFORMATION & COMPUTER STUDIES</h3>
          </div>
          <div class="rules-content">
            <p>To avoid embarrassment and maintain camaraderie with your friends and superiors at our laboratories, please observe the following:</p>
            <ol class="rules-list1">
              <li>Maintain silence, proper decorum, and discipline inside the laboratory. Mobile phones, walkmans, and other personal pieces of equipment must be switched off.</li>
              <li>Games are not allowed inside the lab. This includes computer-related games, card games, and other games that may disturb the operation of the lab.</li>
              <li>Surfing the Internet is allowed only with the permission of the instructor. Downloading and installing of software are strictly prohibited.</li>
              <li>Getting access to other websites not related to the course (especially pornographic and illicit sites) is strictly prohibited.</li>
              <li>Deleting computer files and changing the set-up of the computer is a major offense.</li>
              <li>Observe computer time usage carefully. A fifteen-minute allowance is given for each use. Otherwise, the unit will be given to those who wish to "sit-in".</li>
              <li>Observe proper decorum while inside the laboratory:
                <ul>
                  <li>Do not get inside the lab unless the instructor is present.</li>
                  <li>All bags, knapsacks, and the likes must be deposited at the counter.</li>
                  <li>Follow the seating arrangement of your instructor.</li>
                  <li>At the end of class, all software programs must be closed.</li>
                  <li>Return all chairs to their proper places after using.</li>
                </ul>
              </li>
              <li>Chewing gum, eating, drinking, smoking, and other forms of vandalism are prohibited inside the lab.</li>
              <li>Anyone causing a continual disturbance will be asked to leave the lab. Acts or gestures offensive to the members of the community, including public display of physical intimacy, are not tolerated.</li>
              <li>Persons exhibiting hostile or threatening behavior such as yelling, swearing, or disregarding requests made by lab personnel will be asked to leave the lab.</li>
              <li>For serious offenses, the lab personnel may call the Civil Security Office (CSU) for assistance.</li>
              <li>Any technical problem or difficulty must be addressed to the laboratory supervisor, student assistant, or instructor immediately.</li>
            </ol>
            <div class="disciplinary-action">
              <h3>DISCIPLINARY ACTION</h3>
              <p><strong>First Offense:</strong> The Head or the Dean or OIC recommends to the Guidance Center for a suspension from classes for each offender.</p>
              <p><strong>Second and Subsequent Offenses:</strong> A recommendation for a heavier sanction will be endorsed to the Guidance Center.</p>
            </div>
          </div>
        </div>
      </div>
    <!-- History Section -->
    <div id="history" class="dashboard-section" style="display: none;">
      <h1>History</h1>
      <p>This is the history section. You can display user history here.</p>
    </div>

      <!-- Reservation Section -->
      <div id="reservations" class="dashboard-section">
        <div class="view-reservations-button">
          <!-- Add a "View Reservations" Button -->
          <button id="viewReservationsBtn">
            <i class="fas fa-eye"></i> View Reservations
          </button>
        </div>
        <h1>Reservation Form</h1>
        <form id="reservationForm" action="/reservations" method="POST">
          <div class="form-group">
            <label for="lab_id">Lab:</label>
            <select id="lab_id" name="lab_id" required>
              <option value="" disabled selected>Select Lab</option>
              {% for lab in labs %}
              <option value="{{ lab.id }}">{{ lab.lab_name }}</option>
              {% endfor %}
            </select>
          </div>
      
          <div class="form-group">
            <label for="purpose">Purpose:</label>
            <select id="purpose_select" name="purpose_select" required>
              <option value="" disabled selected>Select Purpose</option>
              <option value="Class">Class</option>
              <option value="Research">Research</option>
              <option value="Meeting">Meeting</option>
              <option value="Coding">Coding</option>
              <option value="Assignment Work">Assignment Work</option>
              <option value="Project Development">Project Development</option>
            </select>
          </div>
      
          <div class="form-group">
            <label for="reservation_date">Reservation Date:</label>
            <input type="date" id="reservation_date" name="reservation_date" required pattern="\d{4}-\d{2}-\d{2}" min="{{ current_date }}" />
            <small id="dateError" class="error-message" style="color: red; display: none;">You cannot select a past date.</small>
          </div>
      
          <div class="form-group">
            <label for="time_in">Time In:</label>
            <input type="time" id="time_in" name="time_in" required />
          </div>
      
          <div class="form-group">
            <label for="time_out">Time Out:</label>
            <input type="time" id="time_out" name="time_out" required />
            <small id="timeError" class="error-message" style="color: red; display: none;">Time Out must be after Time In.</small>
          </div>
      
          <button type="submit">
            <i class="fas fa-calendar-check"></i> Submit Reservation
          </button>
        </form>
      </div>

          <!-- Reservations Table Section -->
          <div id="reservationsTable" class="dashboard-section" style="display: none;">
               <!-- Add a "Back" Button -->
               <button id="backToReservationsBtn">
                <i class="fas fa-arrow-left"></i> Back to Reservations
              </button>
              <table class="reservations-table">
                <thead>
                  <tr>
                    <th>Student Name</th>
                    <th>Purpose</th>
                    <th>Reservation Date</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Reservations will be dynamically inserted here -->
                  <tr>
                    <td>John Doe</td>
                    <td>Research</td>
                    <td>2023-10-15</td>
                    <td>09:00</td>
                    <td>11:00</td>
                    <td>Pending</td>
                    <td><button class="approve-btn">Approve</button></td>
                  </tr>
                  <tr>
                    <td>Jane Smith</td>
                    <td>Class</td>
                    <td>2023-10-16</td>
                    <td>10:00</td>
                    <td>12:00</td>
                    <td>Approved</td>
                    <td><button class="approve-btn" disabled>Approved</button></td>
                  </tr>
                </tbody>
              </table>
              

          </div>





        <div id="laboratories" class="dashboard-section">
          <h1>Laboratories</h1>

              <!-- Bottom Section: Laboratories -->
        <div class="laboratories-section">
          <h2>Laboratories</h2>
          <div class="laboratory-grid">
              {% for lab in labs %}
              <a href="#" class="laboratory-card">
                  <div class="lab-icon">
                      <i class="fas fa-laptop-code"></i> <!-- Computer Lab Icon -->
                  </div>
                  <h3>{{ lab.lab_name }}</h3> <!-- Directly display lab name -->
              </a>
              {% endfor %}
          </div>
      </div>
        </div>

        <div id="sessions" class="dashboard-section" style="display: none;">
          <h1>Sessions</h1>
        
          <!-- Current Session Status -->
          <div id="current-session">
            <h2>Current Session</h2>
            <h3>{{ current_session['sessions_left'] if current_session else 'No session found' }}</h3>
          </div>
        
          <!-- Session Duration Graph -->
          <div id="session-graph">
            <h2>Session Duration</h2>
            <div class="chart-container">
              <canvas id="sessionChart"></canvas>
            </div>
          </div>
        
          <!-- Session History -->
          <div id="session-history">
            <h2>Session History</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Session ID</th>
                    <th>Login Time</th>
                    <th>Logout Time</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody id="session-history-body">
                  <!-- Session history rows will be dynamically inserted here -->
                </tbody>
              </table>
            </div>
            <div class="pagination-controls">
              <button id="prev-page" disabled>Previous</button>
              <span id="page-info">Page 1 of 1</span>
              <button id="next-page" disabled>Next</button>
            </div>
          </div>



        </div>

  

<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
  // Section Toggling Logic
  const links = document.querySelectorAll('.sidebar-links a');
  const sections = document.querySelectorAll('.dashboard-section');

  // Function to show the selected section and hide others
  function showSection(sectionId) {
    sections.forEach(section => {
      section.style.display = section.id === sectionId ? 'block' : 'none';
    });
    localStorage.setItem('activeSection', sectionId); // Save the active section
  }

  // Function to set the active link
  function setActiveLink(sectionId) {
    links.forEach(link => {
      link.classList.toggle('active', link.getAttribute('data-section') === sectionId);
    });
  }

  // Load the active section from localStorage
  const activeSection = localStorage.getItem('activeSection') || 'dashboard';
  showSection(activeSection);
  setActiveLink(activeSection);

  // Add click event listeners to sidebar links
  links.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const sectionId = this.getAttribute('data-section');
      showSection(sectionId);
      setActiveLink(sectionId);
    });
  });

  // Clear localStorage on logout
  const logoutLink = document.getElementById('logout-link');
  if (logoutLink) {
    logoutLink.addEventListener('click', function () {
      localStorage.removeItem('activeSection');
    });
  }

  // Profile Picture Upload Handling
  const profilePictureUpload = document.getElementById('profile-picture-upload');
  if (profilePictureUpload) {
    profilePictureUpload.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('profile-picture').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Fetch announcements
  const announcementsList = document.getElementById('announcements-list');
  if (announcementsList) {
    fetchAnnouncements();
  }

  // Fetch labs for dropdown
  fetchLabs();

  // Fetch session history for the logged-in student
  const studentIdno = "{{ session.student_idno }}"; // Get student ID from session
  if (studentIdno) {
    fetchSessionHistory(studentIdno);
  }
});

// Function to save profile changes
function saveProfileChanges() {
  const updatedData = {
    firstname: document.getElementById('editable-firstname').value,
    lastname: document.getElementById('editable-lastname').value,
    midname: document.getElementById('editable-midname').value,
    course: document.getElementById('editable-course').value,
    year_level: document.getElementById('editable-year-level').value,
    email: document.getElementById('editable-email').value,
    username: document.getElementById('editable-username').value
  };

  const formData = new FormData();
  formData.append('data', JSON.stringify(updatedData));
  const profilePictureFile = document.getElementById('profile-picture-upload').files[0];
  if (profilePictureFile) {
    formData.append('profile_picture', profilePictureFile);
  }

  fetch('/update_profile', {
    method: 'POST',
    body: formData
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        alert('Profile updated successfully!');
        window.location.reload(); // Refresh the page to reflect changes
      } else {
        alert('Failed to update profile: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while updating the profile.');
    });
}

// Function to fetch announcements
function fetchAnnouncements() {
  fetch('/get_announcements')
    .then(response => response.json())
    .then(data => {
      const announcementsList = document.getElementById('announcements-list');
      if (announcementsList) {
        announcementsList.innerHTML = ''; // Clear existing announcements

        data.forEach(announcement => {
          const announcementDate = new Date(announcement.announcement_date).toLocaleString();

          const announcementBox = document.createElement('div');
          announcementBox.className = 'announcement-box';

          announcementBox.innerHTML = `
            <div class="announcement-header">
              <span class="announcement-date">${announcementDate}</span>
              <span class="announcement-admin">Posted by: ${announcement.admin_username}</span>
            </div>
            <div class="announcement-content">
              <p>${announcement.announcement_text}</p>
            </div>
          `;

          announcementsList.appendChild(announcementBox);
        });
      }
    })
    .catch(error => console.error('Error fetching announcements:', error));
}

function fetchLabs() {
  fetch('/get_labs')
    .then(response => response.json())
    .then(data => {
      const labSelect = document.getElementById('lab_name');
      if (labSelect) {
        labSelect.innerHTML = '<option value="">Select Lab</option>'; // Reset options

        if (data.success && data.labs.length > 0) {
          data.labs.forEach(lab => {
            const option = document.createElement('option');
            option.value = lab.id;  // Use the lab ID as the value
            option.textContent = lab.lab_name;  // Use the lab name as the display text
            labSelect.appendChild(option);
          });
        } else {
          console.error('No labs found or error in response');
        }
      }
    })
    .catch(error => console.error('Error fetching labs:', error));
}

function formatDuration(seconds) {
  if (!seconds) return 'N/A';

  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;

  let durationString = '';
  if (hours > 0) durationString += `${hours}h `;
  if (minutes > 0) durationString += `${minutes}m `;
  if (secs > 0 || durationString === '') durationString += `${secs}s`;

  return durationString.trim();
}

let currentPage = 1;
let rowsPerPage = 5;
let sessionData = [];

function fetchSessionHistory(studentIdno) {
  fetch(`/get_session_history/${studentIdno}`)
    .then(response => response.json())
    .then(data => {
      sessionData = data;
      renderTable();
      renderChart();
    })
    .catch(error => console.error('Error fetching session history:', error));
}

function renderTable() {
  const sessionHistoryBody = document.getElementById('session-history-body');
  const prevButton = document.getElementById('prev-page');
  const nextButton = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');

  if (sessionHistoryBody) {
    sessionHistoryBody.innerHTML = ''; // Clear existing rows

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = sessionData.slice(start, end);

    paginatedData.forEach((session, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>Session ${start + index + 1}</td>
        <td>${session.login_time}</td>
        <td>${session.logout_time || 'Active'}</td>
        <td>${formatDuration(session.duration)}</td>
      `;
      sessionHistoryBody.appendChild(row);
    });

    // Update pagination controls
    prevButton.disabled = currentPage === 1;
    nextButton.disabled = end >= sessionData.length;
    pageInfo.textContent = `Page ${currentPage} of ${Math.ceil(sessionData.length / rowsPerPage)}`;
  }
}

function renderChart() {
  const loginTimes = [];
  const durationsInSeconds = [];

  sessionData.forEach(session => {
    if (session.logout_time) {
      loginTimes.push(session.login_time);
      durationsInSeconds.push(session.duration);
    }
  });

  const ctx = document.getElementById('sessionChart')?.getContext('2d');
  if (ctx) {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: loginTimes,
        datasets: [{
          label: 'Session Duration',
          data: durationsInSeconds,
          backgroundColor: 'hsla(273, 77%, 65%, 0.2)',
          borderColor: 'hsl(273, 77%, 65%)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointBackgroundColor: 'hsl(273, 77%, 65%)',
          pointBorderColor: 'hsl(273, 77%, 65%)',
          pointHoverRadius: 5,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'nearest',
          intersect: false,
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              display: false,
            },
            title: {
              display: window.innerWidth > 768,
              text: 'Duration (seconds)'
            },
            ticks: {
              color: 'hsl(273, 77%, 65%)',
            }
          },
          x: {
            grid: {
              display: false,
            },
            title: {
              display: window.innerWidth > 768,
              text: 'Login Time'
            },
            ticks: {
              display: window.innerWidth > 768,
              color: 'hsl(273, 77%, 65%)',
            }
          }
        },
        plugins: {
          legend: {
            display: window.innerWidth > 768,
            position: 'top',
            labels: {
              color: 'hsl(273, 77%, 65%)',
            }
          },
          tooltip: {
            enabled: true,
            mode: 'nearest',
            intersect: false,
            backgroundColor: 'hsl(273, 77%, 65%)',
            titleColor: '#fff',
            bodyColor: '#fff',
            callbacks: {
              label: function (context) {
                const durationInSeconds = context.raw;
                const hours = Math.floor(durationInSeconds / 3600);
                const minutes = Math.floor((durationInSeconds % 3600) / 60);
                const seconds = durationInSeconds % 60;
                return `Duration: ${hours}h ${minutes}m ${seconds}s`;
              }
            }
          }
        }
      }
    });
  }
}

// Pagination event listeners
document.getElementById('prev-page').addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});

document.getElementById('next-page').addEventListener('click', () => {
  if (currentPage < Math.ceil(sessionData.length / rowsPerPage)) {
    currentPage++;
    renderTable();
  }
});

// Utility function to format duration
function formatDuration(durationInSeconds) {
  const hours = Math.floor(durationInSeconds / 3600);
  const minutes = Math.floor((durationInSeconds % 3600) / 60);
  const seconds = durationInSeconds % 60;
  return `${hours}h ${minutes}m ${seconds}s`;
}

let inactivityTime = function () {
  const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 minutes in milliseconds
  let timeout;

  // Function to log out the user
  function logout() {
    fetch('/logout', { method: 'POST' })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        }
      });
  }

  // Function to reset the inactivity timer
  function resetTimer() {
    clearTimeout(timeout);
    timeout = setTimeout(logout, INACTIVITY_LIMIT); // Set new timeout
  }

  // Start the timer when the page loads
  resetTimer();

  // Event listeners to reset the timer on user activity
  document.onmousemove = resetTimer;
  document.onkeypress = resetTimer;
  document.onscroll = resetTimer;
};

// Start tracking inactivity
inactivityTime();

function checkSidebarHeight() {
  const sidebar = document.querySelector('.sidebar');
  const sidebarContentHeight = sidebar.scrollHeight; // Get the total height of the sidebar content

  // If sidebar content height exceeds 662px, apply max-height
  if (sidebarContentHeight > 662) {
    sidebar.classList.add('max-height');
  } else {
    sidebar.classList.remove('max-height');
  }
}

// Run the function on page load and window resize
window.addEventListener('load', checkSidebarHeight);
window.addEventListener('resize', checkSidebarHeight);


// Weekly Lab Usage Chart (Line Chart)
const weeklyUsageCtx = document.getElementById('weeklyUsageChart').getContext('2d');

// Create a gradient for the chart background below the line
const gradient = weeklyUsageCtx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(207, 159, 255, 0.3)'); // Light purple (matches line color)
gradient.addColorStop(1, 'rgba(207, 159, 255, 0)'); // Transparent

// Initialize the chart with empty data
const weeklyUsageChart = new Chart(weeklyUsageCtx, {
  type: 'line',
  data: {
    labels: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'], // Include Sunday
    datasets: [{
      label: 'Sessions Count',
      data: [0, 0, 0, 0, 0, 0, 0], // Start with 0s (7 days)
      borderColor: 'hsl(273, 77%, 65%)', // Purple line color
      borderWidth: 3, // Slightly thicker line
      fill: true, // Fill the area under the line
      backgroundColor: gradient, // Use the gradient as the fill background
      tension: 0.4, // Smooth the line
      pointRadius: 5, // Make data points larger
      pointBackgroundColor: 'hsl(273, 77%, 65%)', // Purple point color
      pointBorderColor: '#fff', // White border for points
      pointHoverRadius: 7, // Increase size on hover
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false, // Allow the chart to resize freely
    scales: {
      y: {
        beginAtZero: true,
        grid: {
          color: 'rgba(200, 200, 200, 0.1)', // Light grid lines
          lineWidth: 1,
        },
        ticks: {
          color: 'hsl(273, 77%, 65%)', // Purple tick labels
        },
      },
      x: {
        display: window.innerWidth > 600, // Hide x-axis labels on small screens
        grid: {
          display: false, // Hide vertical grid lines
        },
        ticks: {
          color: 'hsl(273, 77%, 65%)', // Purple tick labels
        },
      },
    },
    plugins: {
      legend: {
        display: window.innerWidth > 600, // Hide legend on small screens
        position: 'top',
        labels: {
          color: 'hsl(273, 77%, 65%)', // Purple legend text
        },
      },
      tooltip: {
        enabled: true,
        backgroundColor: 'hsl(273, 77%, 65%)', // Purple tooltip background
        titleColor: '#fff', // White tooltip title
        bodyColor: '#fff', // White tooltip body
      },
    },
  },
});

// Pass the student ID from Flask to JavaScript
const studentId = "{{ student.idno }}"; // Replace with your actual variable
updateChart(studentId); // Call the function with the student ID

function updateChart(studentId) {
  fetch(`/get_weekly_usage/${studentId}`)
    .then(response => response.json())
    .then(data => {
      console.log("Fetched Data:", data);  // Debugging: Print the fetched data

      const labels = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; // Include Sunday
      const usageData = labels.map(day => data[day] || 0); // If no record, set to 0

      console.log("Mapped Data:", usageData);  // Debugging: Print the mapped data

      // Update the chart data
      weeklyUsageChart.data.labels = labels;
      weeklyUsageChart.data.datasets[0].data = usageData;
      weeklyUsageChart.update();
    })
    .catch(error => console.error('Error fetching session data:', error));
}

// Handle window resize to dynamically show/hide labels and legend
window.addEventListener('resize', () => {
  weeklyUsageChart.options.scales.x.display = window.innerWidth > 600;
  weeklyUsageChart.options.plugins.legend.display = window.innerWidth > 600;
  weeklyUsageChart.update();
});


const progressBars = document.querySelectorAll('.circular-progress');

progressBars.forEach(progressBar => {
    const progress = parseFloat(progressBar.getAttribute('data-progress'));
    const max = parseFloat(progressBar.getAttribute('data-max'));
    const percentage = (progress / max) * 100; // Calculate the percentage
    const progressValue = (progress / max) * 283; // Calculate the stroke-dashoffset

    const progressCircle = progressBar.querySelector('.progress-bar');
    progressCircle.style.strokeDashoffset = 283 - progressValue; // Update the progress bar

    // Set the progress bar color based on the percentage
    if (percentage >= 75) {
        progressCircle.style.stroke = '#4CAF50'; // Green
    } else if (percentage >= 50) {
        progressCircle.style.stroke = '#FFC107'; // Yellow
    } else if (percentage >= 25) {
        progressCircle.style.stroke = '#FF5722'; // Dark Orange (closer to red)
    } else {
        progressCircle.style.stroke = '#F44336'; // Red
    }
});


document.getElementById('reservationForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    // Convert reservation_date to YYYY-MM-DD
    const dateInput = document.getElementById('reservation_date');
    const formattedDate = new Date(dateInput.value).toISOString().split('T')[0];
    formData.set('reservation_date', formattedDate);

    try {
        const response = await fetch('/reservations', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert(result.message); // Show alert on success
            location.reload(); // Refresh the page
        } else {
            alert(result.message); // Show alert for errors
        }
    } catch (error) {
        alert('An error occurred while submitting the form.');
    }
});


  // JavaScript to handle the SPA behavior
  document.getElementById('viewReservationsBtn').addEventListener('click', function() {
    // Hide the reservation form
    document.getElementById('reservations').style.display = 'none';
    // Show the reservations table
    document.getElementById('reservationsTable').style.display = 'block';
    // Optionally, load reservations data here via AJAX
  });

  document.getElementById('backToReservationsBtn').addEventListener('click', function() {
    // Hide the reservations table
    document.getElementById('reservationsTable').style.display = 'none';
    // Show the reservation form
    document.getElementById('reservations').style.display = 'block';
  });
  document.addEventListener('DOMContentLoaded', function () {
  const approveButtons = document.querySelectorAll('.approve-btn');

  approveButtons.forEach((button) => {
    button.addEventListener('click', function () {
      const row = this.closest('tr');
      const statusCell = row.querySelector('td:nth-child(6)');
      const actionCell = row.querySelector('td:nth-child(7)');

      // Update status to "Approved"
      statusCell.textContent = 'Approved';

      // Disable the button
      this.disabled = true;
      this.textContent = 'Approved';

      // Optional: Send an AJAX request to update the status in the database
      const reservationId = row.dataset.reservationId; // Assuming you have a data-reservation-id attribute
      fetch(`/approve-reservation/${reservationId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            console.log('Reservation approved successfully');
          } else {
            console.error('Failed to approve reservation');
          }
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    });
  });
});


const reservationDateInput = document.getElementById('reservation_date');
  const timeInInput = document.getElementById('time_in');
  const timeOutInput = document.getElementById('time_out');
  const dateError = document.getElementById('dateError');
  const timeError = document.getElementById('timeError');

  // Set the minimum date to today
  const today = new Date().toISOString().split('T')[0];
  reservationDateInput.setAttribute('min', today);

  // Validate date on input change
  reservationDateInput.addEventListener('change', function () {
    const selectedDate = new Date(this.value);
    const currentDate = new Date();

    if (selectedDate < currentDate) {
      dateError.style.display = 'block';
      this.setCustomValidity('You cannot select a past date.');
    } else {
      dateError.style.display = 'none';
      this.setCustomValidity('');
    }
  });

  // Validate time-out on input change
  timeOutInput.addEventListener('change', function () {
    const timeIn = timeInInput.value;
    const timeOut = this.value;

    if (timeOut <= timeIn) {
      timeError.style.display = 'block';
      this.setCustomValidity('Time Out must be after Time In.');
    } else {
      timeError.style.display = 'none';
      this.setCustomValidity('');
    }
  });

  // Validate time-in on input change
  timeInInput.addEventListener('change', function () {
    const timeIn = this.value;
    const timeOut = timeOutInput.value;

    if (timeOut && timeOut <= timeIn) {
      timeError.style.display = 'block';
      timeOutInput.setCustomValidity('Time Out must be after Time In.');
    } else {
      timeError.style.display = 'none';
      timeOutInput.setCustomValidity('');
    }
  });

  // Prevent form submission if there are validation errors
  document.getElementById('reservationForm').addEventListener('submit', function (event) {
    if (!this.checkValidity()) {
      event.preventDefault();
    }
  });
</script>
{% endblock %}